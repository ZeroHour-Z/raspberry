# 树莓派视觉识别系统

这是一个基于树莓派的多任务视觉识别系统，主要用于机器人竞赛或自动化任务。系统集成了QR码识别、颜色检测、十字线检测等功能，采用多线程架构实现实时处理。

## 项目概述

本系统是一个完整的机器人视觉解决方案，包含以下核心功能：

- **QR码识别**：支持多种图像预处理策略的二维码识别
- **颜色检测**：基于YOLOv5模型的实时颜色物体检测
- **十字线检测**：几何特征分析的十字线标记检测
- **串口通信**：与下位机（如Arduino）的实时通信
- **GPIO控制**：LED指示灯和信号反馈

## 系统架构

### 硬件配置

- **树莓派**：主控制器
- **身体摄像头** (`/dev/body0`)：用于QR码识别
- **手臂摄像头** (`/dev/arm0`)：用于颜色检测
- **串口** (`/dev/ttyAMA0`)：与下位机通信
- **GPIO 16**：LED指示灯控制

### 软件架构

```
main.py (主控制器)
├── QRread.py (QR码识别模块)
├── ColorDetect.py (颜色检测模块)
├── CrossDetect.py (十字线检测模块)
├── sig.py (GPIO控制模块)
└── utils/ (工具库)
    ├── augmentations.py (图像增强)
    └── general.py (通用工具)
```

## 核心模块

### 1. 主控制系统 (main.py)

**功能**：状态机控制器，管理不同视觉任务的切换

**状态说明**：
- `stat=0/2`：QR码识别任务
- `stat=1`：颜色检测任务
- `stat=3`：等待状态

**特点**：
- 多线程架构，图像采集与推理分离
- 串口通信协议，支持实时状态切换
- LED指示灯提供视觉反馈

### 2. QR码识别模块 (QRread.py)

**功能**：多策略QR码识别

**识别策略**：
1. 直接pyzbar解码
2. 图像增强后解码
3. 高斯模糊预处理
4. 二值化处理
5. 形态学操作
6. 基于定位点的精确识别

**特点**：
- 自适应阈值调整
- 多线程图像采集
- 实时识别反馈

### 3. 颜色检测模块 (ColorDetect.py)

**功能**：基于ONNX模型的颜色物体检测

**支持颜色**：
- `he`：红色
- `ba`：蓝色
- `ho`：橙色
- `lv`：绿色
- `la`：紫色
- `bj`：背景

**特点**：
- 支持多种模型（YOLO、分类模型）
- 可配置置信度阈值
- 暂停/继续控制机制

### 4. 十字线检测模块 (CrossDetect.py)

**功能**：几何特征分析的十字线标记检测

**检测流程**：
1. 图像预处理（灰度化、模糊、二值化）
2. 形态学操作
3. 轮廓检测
4. 几何特征筛选
5. 角度计算

**特点**：
- 基于面积、宽高比、角点数量筛选
- 实时角度计算
- 可视化调试功能

## 安装和配置

### 环境要求

- Python 3.8+
- OpenCV 4.x
- PyTorch
- ONNX Runtime
- pyzbar
- pyserial
- RPi.GPIO

### 安装步骤

1. **克隆项目**
```bash
git clone <repository-url>
cd raspberry
```

2. **安装依赖**
```bash
pip install -r requirements.txt
```

3. **配置硬件**
- 连接摄像头到指定端口
- 配置串口通信
- 连接LED到GPIO 16

4. **运行程序**
```bash
python main.py
```

### 安装注意事项

**pip报错解决方案**：
```bash
# 方法1：重命名EXTERNALLY-MANAGED文件
sudo mv /usr/lib/python3.x/EXTERNALLY-MANAGED /usr/lib/python3.x/EXTERNALLY-MANAGED.bk
# 注意：将3.x改成具体的Python版本号

# 方法2：使用pipx安装（推荐）
pipx install --include-deps <package-name>
```

## 使用说明

### 启动流程

1. **系统初始化**
   - GPIO引脚配置
   - 摄像头初始化
   - ONNX模型加载
   - 串口通信建立

2. **任务执行**
   - QR码识别阶段
   - 颜色检测阶段
   - 状态切换控制

3. **信号反馈**
   - LED指示灯闪烁
   - 串口数据发送
   - 状态确认等待

### 串口通信协议

**发送格式**：
- QR码识别：字母A-Z（对应数字1-26）
- 颜色检测：字母A-Z（对应颜色映射）

**接收信号**：
- `ok`：任务完成确认
- `ko`：异常情况处理
- `Y`：颜色检测完成
- `Z`：继续检测
- `S,Q,T,U,R`：特定颜色标识

### 配置文件

**模型文件**：
- `better_t2.onnx`：主要检测模型
- `better_cls.onnx`：分类模型
- `better_lite.onnx`：轻量级模型

**参数配置**：
- 摄像头设备路径
- 串口波特率设置
- 置信度阈值
- 图像预处理参数

## 开发指南

### 添加新功能

1. **创建新模块**
   - 继承现有架构
   - 实现标准接口
   - 添加线程安全机制

2. **集成到主系统**
   - 修改状态机逻辑
   - 添加串口通信协议
   - 更新LED反馈

3. **测试和调试**
   - 单元测试
   - 集成测试
   - 性能优化

### 代码规范

- 遵循PEP 8编码规范
- 添加详细的中文注释
- 使用类型提示
- 异常处理机制

### 性能优化

- 多线程架构
- 图像缓存机制
- 模型推理优化
- 内存管理

## 故障排除

### 常见问题

1. **摄像头无法打开**
   - 检查设备权限
   - 确认设备路径
   - 验证硬件连接

2. **串口通信失败**
   - 检查波特率设置
   - 确认设备权限
   - 验证硬件连接

3. **模型加载失败**
   - 检查模型文件路径
   - 确认ONNX版本兼容性
   - 验证模型格式

4. **识别准确率低**
   - 调整置信度阈值
   - 优化图像预处理参数
   - 检查环境光照条件

### 调试工具

- `test.py`：摄像头测试
- `serial_test.py`：串口通信测试
- `faster_pre.py`：推理性能测试

## 许可证

本项目采用AGPL-3.0许可证。

## 贡献指南

欢迎提交Issue和Pull Request来改进项目。

## 联系方式

如有问题或建议，请通过以下方式联系：
- 提交GitHub Issue
- 发送邮件至项目维护者

---

**注意**：本项目专为树莓派环境设计，在其他平台使用时可能需要调整硬件相关的代码。 